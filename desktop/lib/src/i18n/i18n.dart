import 'package:flutter/material.dart';
import '../state/user_preferences.dart';

class I18nScope extends InheritedWidget {
  final I18nState data;

  const I18nScope({required this.data, required super.child, super.key});

  static I18nState of(BuildContext context) {
    final scope = context.dependOnInheritedWidgetOfExactType<I18nScope>();
    if (scope == null) throw StateError('I18nScope not found');
    return scope.data;
  }

  @override
  bool updateShouldNotify(covariant I18nScope oldWidget) => oldWidget.data != data;
}

class I18n extends StatefulWidget {
  final Widget child;

  const I18n({required this.child, super.key});

  @override
  I18nState createState() => I18nState();
}

class I18nState extends State<I18n> {
  Locale _locale = Locale(UserPreferences.locale ?? 'en');

  Locale get locale => _locale;

  void setLocale(Locale locale) {
    if (locale == _locale) return;
    setState(() => _locale = locale);
    UserPreferences.setLocale(locale.languageCode);
  }

  String t(String key, {Map<String, String>? args}) {
    final map = _locale.languageCode == 'de' ? _localizedDe : _localizedEn;
    var value = map[key] ?? key;
    args?.forEach((k, v) {
      value = value.replaceAll('{$k}', v);
    });
    return value;
  }

  @override
  Widget build(BuildContext context) {
    return I18nScope(data: this, child: widget.child);
  }
}

// Helper to translate without a BuildContext (useful in static or non-widget code)
String translateForLocale(String key, String? localeCode, {Map<String, String>? args}) {
  final map = (localeCode ?? 'en') == 'de' ? _localizedDe : _localizedEn;
  var value = map[key] ?? key;
  args?.forEach((k, v) {
    value = value.replaceAll('{$k}', v);
  });
  return value;
}

const Map<String, String> _localizedEn = {
  'zen_ai': 'Zen AI',
  'chat': 'Chat',
  'greeting': 'Hello, how are you?',
  'greeting_with_name': 'Hello {name}, how are you?',
  'no_messages_yet': 'No messages yet. Say hello!',
  'uploading_file': 'Uploading file…',
  'uploading': 'Uploading…',
  'upload_file': 'Upload file',
  'hint_send_message': 'Send a message...',
  'voice': 'Voice',
  'send': 'Send',
  'download': 'Download',
  'choose_ai_companion': 'Choose your AI companion',
  'use_model': 'Use model',
  'selected_model': 'Selected: {name}',
  'select_model': 'Select model',
  'vision': 'Vision',
  'chat_cap': 'Chat',
  'code': 'Code',
  'speed': 'Speed',
  'image_cap': 'Image',
  'reasoning': 'Reasoning',
  'secure': 'Secure',
  'writing': 'Writing',
  'ideation': 'Ideation',
  'math': 'Math',
  'translate': 'Translate',
  'animation': 'Animation',
  'style': 'Style',
  'markdown_demo': 'Markdown Demo',
  'please_sign_in_create_notes': 'Please sign in to create notes.',
  'new_note': 'New note',
  'please_sign_in_start_chat': 'Please sign in to start chatting.',
  'please_sign_in_upload_files': 'Please sign in to upload files.',
  'unable_read_file': 'Unable to read the selected file. Please try again.',
  'file_upload_failed_try_again': 'File upload failed. Please try again.',
  'please_sign_in_download_files': 'Please sign in to download files.',
  'unable_download_missing_user': 'Unable to download file: missing user ID.',
  'could_not_open_download': 'Could not open download for {fileName}.',
  'unable_download_file_error': 'Unable to download file: {error}',
  'new_chat': 'New chat',
  'search': 'Search',
  'notes': 'Notes',
  'email': 'Email',
  'calendar': 'Calendar',
  'rename_chat': 'Rename chat',
  'chat_name': 'Chat name',
  'cancel': 'Cancel',
  'save': 'Save',
  'delete_chat': 'Delete chat',
  'delete_chat_confirm': 'Are you sure you want to delete "{chatTitle}"? This action cannot be undone.',
  'delete': 'Delete',
  'file_upload_failed': 'File upload failed: {error}',
  'file_selection_failed': 'File selection failed: {error}',
  'guest': 'Guest',
  'untitled_chat': 'Untitled chat',
  'unable_to_download_file': 'Unable to download file: {error}',
  'minimize': 'Minimize',
  'maximize': 'Maximize',
  'restore': 'Restore',
  'close': 'Close',
  'language': 'Language',
  'change': 'Change',
  'lang_english': 'English',
  'lang_german': 'German (Deutsch)',
  'search_notes_and_chats': 'Search notes and chats...',
  'no_results': 'No results',
  'sign_out': 'Sign out',
  'display_name': 'Display name',
  'not_set': 'Not set',
  'refresh_from_server': 'Refresh from server',
  'edit_display_name': 'Edit display name',
  'email_label': 'Email',
  'firebase_uid': 'Firebase UID',
  'token_expires': 'Token expires',
  'profile_created': 'Profile created',
  'profile_updated': 'Profile updated',
  'synced_chats': 'Synced chats',
  'no_chats_stored': 'No chats stored yet.',
  'chats_available': '{count} chats available.',
  'refresh_chats': 'Refresh chats',
  'account_status': 'Account status',
  'recently_linked': 'Recently linked. Explore your workspace!',
  'signed_in_user': 'Signed in user',
  'appearance': 'Appearance',
  'light': 'Light',
  'dark': 'Dark',
  'system': 'System',
  'accent_color': 'Accent color',
  'assistant': 'Assistant',
  'desktop_notifications': 'Desktop notifications',
  'desktop_notifications_sub': 'Get a ping when Zen finishes a response.',
  'smart_reply_suggestions': 'Smart reply suggestions',
  'smart_reply_sub': 'Surface quick follow-up ideas in the composer.',
  'auto_archive_chats': 'Auto-archive inactive chats',
  'auto_archive_sub': 'Keep the sidebar tidy after 14 days of inactivity.',
  'ai_note_automation': 'AI note automation',
  'mcp_host_or_url': 'MCP host or URL',
  'port': 'Port',
  'auto_connect_on_launch': 'Auto-connect on launch',
  'auto_connect_sub': 'Reconnect to the notes MCP server whenever Zen starts.',
  'mcp_description': 'The MCP notes server lets the assistant create and manage your notes securely.',
  'disconnect': 'Disconnect',
  'connect': 'Connect',
  'refresh_tools': 'Refresh tools',
  'workspace': 'Workspace',
  'data_residency': 'Data residency',
  'eu_restricted': 'EU-restricted',
  'chats': 'Chats',
  'sign_in_to_view_activity': 'Sign in to view your recent chat activity.',
  'no_chat_history': 'No chat history yet. Start a conversation to see it here.',
  'your_notes': 'Your notes',
  'create_new_note': 'Create new note',
  'close_notes_tooltip': 'Close notes',
  'search_through_notes': 'Search through all notes',
  'no_notes_match': 'No notes match your search',
  'no_content_yet': 'No content yet',
  'edit': 'Edit',
  'add': 'Add',
  'add_keyword': 'Add keyword',
  'keyword_hint': 'keyword',
  'write_note_content': 'Write note content...',
  'keywords': 'Keywords',
  'trigger_words': 'Trigger words',
  'open_in_google_calendar': 'Open in Google Calendar',
  'search_emails': 'Search emails...',
  'ask_anything': 'Ask anything...',
  'account_center': 'Account center',
  'account_center_description': 'Manage personal details, preferences, and session history.',
  'tab_profile': 'Profile',
  'tab_preferences': 'Preferences',
  'tab_activity': 'Activity',
  'create_your_account': 'Create your Zen account',
  'sign_in_to_app': 'Sign in to Zen',
  'signup_description': 'Sync chats across devices and keep your prompts backed up securely.',
  'signin_description': 'Enter your credentials to load your chats and personal settings.',
  'password_label': 'Password',
  'please_enter_your_email': 'Please enter your email address',
  'enter_valid_email': 'Enter a valid email',
  'password_min_length': 'Password must be at least 6 characters',
  'reset_password': 'Reset password',
  'forgot_password_query': 'Forgot password?',
  'or_continue_with': 'Or continue with',
  'continue_with_google': 'Continue with Google',
  'display_name_label': 'Display name',
  'update_display_name': 'Update display name',
  'display_name_required': 'Display name is required to create an account',
  'please_wait': 'Please wait...',
  'create_account': 'Create account',
  'sign_in': 'Sign in',
  'have_account_sign_in': 'Have an account already? Sign in',
  'need_account_create': 'Need an account? Create one',
  'custom_accent_color': 'Custom Accent Color',
  'picker_wheel_grid': 'Wheel & Grid',
  'picker_color_wheel': 'Color Wheel',
  'hex_code': 'Hex Code',
  'hex_code_hint': '#FF5733',
  'preview': 'Preview',
  'apply': 'Apply',
  'please_enter_valid_mcp_port': 'Please enter a valid MCP port.',
  'available_tools': 'Available tools',
  'connecting_to': 'Connecting to {host}…',
  'connected_to': 'Connected to {host}',
  'not_connected': 'Not connected',
  'mcp_tools_count': '{count} tool(s)',
  'token_expiry_unknown': 'Token expiry unknown',
  'uid_display': 'UID · {id}',
  'token_valid_until': 'Token valid until {expiry}',
  'unknown_user': 'Unknown user',
  'unknown_uid': 'Unknown UID',
  'please_sign_in_update_display_name': 'Please sign in to update your display name.',
  'account_created_please_sign_in': 'Account created successfully. Please sign in.',
  'unable_to_sign_in': 'Unable to sign in: {error}',
  'please_sign_in_update_notes': 'Please sign in to update notes.',
  'please_sign_in_delete_notes': 'Please sign in to delete notes.',
  'please_sign_in_search_notes': 'Please sign in to search notes.',
  'please_sign_in_view_files': 'Please sign in to view your files.',
  'display_name_cannot_be_empty': 'Display name cannot be empty.',
  'display_name_updated': 'Display name updated to {name}.',
  'auth_required': 'Authentication Required',
  'please_sign_in_access_calendar': 'Please sign in to access your calendar.',
  'connect_google_calendar': 'Connect Google Calendar',
  'sync_your_events': 'Sync your events to stay organized.',
  'add_trigger_word': 'Add trigger word',
  'trigger_word_hint': 'trigger word',
  'new_emails_received': '{count} new email(s) received',
  'failed_to_poll_emails': 'Failed to poll emails: {error}',
  'failed_to_update_flag': 'Failed to update flag: {error}',
  'disconnect_email': 'Disconnect Email',
  'email_account_disconnected': 'Email account disconnected',
  'failed_to_disconnect': 'Failed to disconnect: {error}',
  'retry': 'Retry',
  'loading_ai_summary': 'Loading AI summary…',
  'loading_message': 'Loading message…',
  'disconnect_email_confirm': 'Are you sure you want to disconnect your email account? You will need to reconnect to access your emails again.',
};

const Map<String, String> _localizedDe = {
  'zen_ai': 'Zen AI',
  'please_sign_in_create_notes': 'Melde dich an, um Notizen zu erstellen.',
  'new_note': 'Neue Notiz',
  'please_sign_in_start_chat': 'Melde dich an, um zu chatten.',
  'please_sign_in_upload_files': 'Melde dich an, um Dateien hochzuladen.',
  'unable_read_file': 'Die ausgewählte Datei konnte nicht gelesen werden. Bitte versuche es erneut.',
  'file_upload_failed_try_again': 'Datei-Upload fehlgeschlagen. Bitte erneut versuchen.',
  'please_sign_in_download_files': 'Melde dich an, um Dateien herunterzuladen.',
  'unable_download_missing_user': 'Datei kann nicht heruntergeladen werden: fehlende Benutzer-ID.',
  'could_not_open_download': 'Download für {fileName} konnte nicht geöffnet werden.',
  'unable_download_file_error': 'Datei kann nicht heruntergeladen werden: {error}',
  'new_chat': 'Neuer Chat',
  'rename_chat': 'Chat umbenennen',
  'chat_name': 'Chat-Name',
  'cancel': 'Abbrechen',
  'save': 'Speichern',
  'delete_chat': 'Chat löschen',
  'delete_chat_confirm': 'Möchten Sie "{chatTitle}" wirklich löschen? Diese Aktion kann nicht rückgängig gemacht werden!',
  'delete': 'Löschen',
  'file_upload_failed': 'Datei-Upload fehlgeschlagen: {error}',
  'file_selection_failed': 'Dateiauswahl fehlgeschlagen: {error}',
  'guest': 'Gast',
  'untitled_chat': 'Unbenannter Chat',
  'unable_to_download_file': 'Datei kann nicht heruntergeladen werden: {error}',
  'chat': 'Chat',
  'greeting': 'Hallo, wie geht es dir?',
  'greeting_with_name': 'Hallo {name}, wie geht es dir?',
  'no_messages_yet': 'Noch keine Nachrichten. Sag Hallo!',
  'uploading_file': 'Datei wird hochgeladen…',
  'uploading': 'Wird hochgeladen…',
  'upload_file': 'Datei hochladen',
  'hint_send_message': 'Nachricht senden...',
  'voice': 'Sprache',
  'send': 'Senden',
  'download': 'Herunterladen',
  'minimize': 'Minimieren',
  'maximize': 'Maximieren',
  'restore': 'Wiederherstellen',
  'close': 'Schließen',
  'language': 'Sprache',
  'change': 'Ändern',
  'lang_english': 'Englisch',
  'lang_german': 'Deutsch (Deutsch)',
  'search': 'Suchen',
  'notes': 'Notizen',
  'email': 'E-Mail',
  'calendar': 'Kalender',
  'search_notes_and_chats': 'Notizen und Chats durchsuchen...',
  'no_results': 'Keine Ergebnisse',
  'sign_out': 'Abmelden',
  'display_name': 'Anzeigename',
  'not_set': 'Nicht gesetzt',
  'refresh_from_server': 'Vom Server aktualisieren',
  'edit_display_name': 'Anzeigename bearbeiten',
  'email_label': 'E-Mail',
  'firebase_uid': 'Firebase UID',
  'token_expires': 'Token läuft ab',
  'profile_created': 'Profil erstellt',
  'profile_updated': 'Profil aktualisiert',
  'synced_chats': 'Synchronisierte Chats',
  'no_chats_stored': 'Noch keine Chats gespeichert.',
  'chats_available': '{count} Chats verfügbar.',
  'refresh_chats': 'Chats aktualisieren',
  'account_status': 'Kontostatus',
  'recently_linked': 'Kürzlich verknüpft. Erkunde deinen Arbeitsbereich!',
  'signed_in_user': 'Angemeldeter Nutzer',
  'appearance': 'Erscheinungsbild',
  'light': 'Hell',
  'dark': 'Dunkel',
  'system': 'System',
  'accent_color': 'Akzentfarbe',
  'assistant': 'Assistent',
  'desktop_notifications': 'Desktop-Benachrichtigungen',
  'desktop_notifications_sub': 'Erhalte eine Benachrichtigung, wenn Zen eine Antwort fertigstellt.',
  'smart_reply_suggestions': 'Smart-Reply-Vorschläge',
  'smart_reply_sub': 'Zeige schnelle Folgeideen im Composer an.',
  'auto_archive_chats': 'Inaktive Chats automatisch archivieren',
  'auto_archive_sub': 'Halte die Seitenleiste nach 14 Tagen Inaktivität aufgeräumt.',
  'ai_note_automation': 'KI-Notizautomatisierung',
  'mcp_host_or_url': 'MCP Host oder URL',
  'port': 'Port',
  'auto_connect_on_launch': 'Beim Start automatisch verbinden',
  'auto_connect_sub': 'Stelle beim Start automatisch wieder eine Verbindung zum Notes-MCP her.',
  'mcp_description': 'Der MCP-Notes-Server ermöglicht dem Assistenten, deine Notizen sicher zu erstellen und zu verwalten.',
  'disconnect': 'Trennen',
  'connect': 'Verbinden',
  'refresh_tools': 'Tools aktualisieren',
  'workspace': 'Arbeitsbereich',
  'data_residency': 'Datenresidenz',
  'eu_restricted': 'EU-eingeschränkt',
  'chats': 'Chats',
  'sign_in_to_view_activity': 'Melde dich an, um deine letzten Chat-Aktivitäten anzuzeigen.',
  'no_chat_history': 'Noch keine Chat-Historie. Beginne eine Unterhaltung, um sie hier zu sehen.',
  'your_notes': 'Deine Notizen',
  'create_new_note': 'Neue Notiz erstellen',
  'close_notes_tooltip': 'Notizen schließen',
  'search_through_notes': 'Durchsuche alle Notizen',
  'no_notes_match': 'Keine Notizen entsprechen deiner Suche',
  'no_content_yet': 'Noch kein Inhalt',
  'edit': 'Bearbeiten',
  'add': 'Hinzufügen',
  'add_keyword': 'Stichwort hinzufügen',
  'keyword_hint': 'Stichwort',
  'write_note_content': 'Notizinhalt schreiben...',
  'keywords': 'Stichwörter',
  'trigger_words': 'Trigger-Wörter',
  'open_in_google_calendar': 'In Google Kalender öffnen',
  'search_emails': 'E-Mails durchsuchen...',
  'ask_anything': 'Stelle irgendeine Frage...',
  'select_model': 'Modell auswählen',
  'selected_model': 'Ausgewählt: {name}',
  'use_model': 'Modell verwenden',
  'choose_ai_companion': 'Wähle deinen KI-Begleiter',
  'account_center': 'Konto',
  'account_center_description': 'Verwalte persönliche Daten, Einstellungen und Sitzungsverlauf.',
  'tab_profile': 'Profil',
  'tab_preferences': 'Einstellungen',
  'tab_activity': 'Aktivität',
  'create_your_account': 'Erstelle dein Zen-Konto',
  'sign_in_to_app': 'Bei Zen anmelden',
  'signup_description': 'Synchronisiere Chats auf Geräten und sichere deine Prompts.',
  'signin_description': 'Gib deine Anmeldedaten ein, um Chats und persönliche Einstellungen zu laden.',
  'password_label': 'Passwort',
  'please_enter_your_email': 'Bitte gib deine E-Mail-Adresse ein',
  'enter_valid_email': 'Gib eine gültige E-Mail-Adresse ein',
  'password_min_length': 'Das Passwort muss mindestens 6 Zeichen lang sein',
  'reset_password': 'Passwort zurücksetzen',
  'forgot_password_query': 'Passwort vergessen?',
  'or_continue_with': 'Oder fortfahren mit',
  'continue_with_google': 'Mit Google fortfahren',
  'display_name_label': 'Anzeigename',
  'update_display_name': 'Anzeigename aktualisieren',
  'display_name_required': 'Anzeigename ist erforderlich, um ein Konto zu erstellen',
  'please_wait': 'Bitte warten...',
  'create_account': 'Konto erstellen',
  'sign_in': 'Anmelden',
  'have_account_sign_in': 'Schon ein Konto? Anmelden',
  'need_account_create': 'Benötigst du ein Konto? Erstellen',
  'custom_accent_color': 'Benutzerdefinierte Akzentfarbe',
  'picker_wheel_grid': 'Rad & Raster',
  'picker_color_wheel': 'Farbkreis',
  'hex_code': 'Hex-Code',
  'hex_code_hint': '#FF5733',
  'preview': 'Vorschau',
  'apply': 'Übernehmen',
  'please_enter_valid_mcp_port': 'Bitte gib einen gültigen MCP-Port ein.',
  'available_tools': 'Verfügbare Tools',
  'connecting_to': 'Verbinde mit {host}…',
  'connected_to': 'Verbunden mit {host}',
  'not_connected': 'Nicht verbunden',
  'mcp_tools_count': '{count} Tool(s)',
  'token_expiry_unknown': 'Token-Ablauf unbekannt',
  'uid_display': 'UID · {id}',
  'token_valid_until': 'Token gültig bis {expiry}',
  'unknown_user': 'Unbekannter Benutzer',
  'unknown_uid': 'Unbekannte UID',
  'please_sign_in_update_display_name': 'Melde dich an, um deinen Anzeigenamen zu aktualisieren.',
  'account_created_please_sign_in': 'Konto erfolgreich erstellt. Bitte melde dich an.',
  'unable_to_sign_in': 'Anmeldung fehlgeschlagen: {error}',
  'please_sign_in_update_notes': 'Melde dich an, um Notizen zu aktualisieren.',
  'please_sign_in_delete_notes': 'Melde dich an, um Notizen zu löschen.',
  'please_sign_in_search_notes': 'Melde dich an, um Notizen zu durchsuchen.',
  'please_sign_in_view_files': 'Melde dich an, um deine Dateien anzuzeigen.',
  'display_name_cannot_be_empty': 'Der Anzeigename darf nicht leer sein.',
  'display_name_updated': 'Anzeigename aktualisiert auf {name}.',
  'auth_required': 'Authentifizierung erforderlich',
  'please_sign_in_access_calendar': 'Melde dich an, um auf deinen Kalender zuzugreifen.',
  'connect_google_calendar': 'Google-Kalender verbinden',
  'sync_your_events': 'Synchronisiere deine Ereignisse, um organisiert zu bleiben.',
  'add_trigger_word': 'Trigger-Wort hinzufügen',
  'trigger_word_hint': 'Trigger-Wort',
  'new_emails_received': '{count} neue E-Mail(s) empfangen',
  'failed_to_poll_emails': 'Fehler beim Abrufen von E-Mails: {error}',
  'failed_to_update_flag': 'Fehler beim Aktualisieren des Flags: {error}',
  'disconnect_email': 'E-Mail trennen',
  'email_account_disconnected': 'E-Mail-Konto getrennt',
  'failed_to_disconnect': 'Fehler beim Trennen: {error}',
  'retry': 'Erneut versuchen',
  'loading_ai_summary': 'AI-Zusammenfassung wird geladen…',
  'loading_message': 'Nachricht wird geladen…',
  'disconnect_email_confirm': 'Möchten Sie Ihr E-Mail-Konto wirklich trennen? Sie müssen es erneut verbinden, um wieder auf Ihre E-Mails zuzugreifen.',
};

extension I18nExt on BuildContext {
  String t(String key, {Map<String, String>? args}) => I18nScope.of(this).t(key, args: args);
  Locale get locale => I18nScope.of(this).locale;
  void setLocale(Locale l) => I18nScope.of(this).setLocale(l);
}
