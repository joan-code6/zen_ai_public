name: Remove Secrets and Push to Public Repo

on:
  workflow_dispatch:  # Manual trigger
  push:
    branches:
      - main  # Adjust to your default branch name if different

jobs:
  remove-secrets:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history for proper branching
          persist-credentials: false
      
      - name: Configure Git
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
      
      - name: Create and checkout secrets-removed branch
        run: |
          git checkout -B secrets-removed
      
      - name: Make script executable and run it
        run: |
          chmod +x remove_secrets.sh
          ./remove_secrets.sh
      
      - name: Commit changes
        run: |
          git add -A
          git commit -m "Remove sensitive files and credentials" || echo "No changes to commit"
      
      - name: Clean git history to remove all secrets
        run: |
          git checkout --orphan temp_clean_branch
          git add -A
          git commit -m "Clean repository without secrets or history [skip ci]"
          git branch -D secrets-removed || true
          git branch -m secrets-removed
      
      - name: Push to public repository
        run: |
          git config --global --unset-all http.https://github.com/.extraheader || true
          git config --global credential.helper ""
          git remote add public https://joan-code6:${{ secrets.PUBLIC_REPO_TOKEN }}@github.com/joan-code6/zen_ai_public.git
          git push public secrets-removed:main --force
